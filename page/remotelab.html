<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Lab Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .slider::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            border: 2px solid #1E40AF;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .slider::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            border: 2px solid #1E40AF;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
        }

        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }

        /* Custom scrollbar - Cross-browser support */
        /* WebKit browsers (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin: 2px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.6) 0%, rgba(139, 92, 246, 0.6) 100%);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8) 0%, rgba(139, 92, 246, 0.8) 100%);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        ::-webkit-scrollbar-thumb:active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(139, 92, 246, 0.9) 100%);
        }

        ::-webkit-scrollbar-corner {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(59, 130, 246, 0.6) rgba(255, 255, 255, 0.05);
        }

        /* Additional scrollbar styling for specific elements */
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }

        .overflow-y-auto::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 3px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.4);
            border-radius: 3px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.6);
        }

        /* Device Selection - Matching current theme */
        .device-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .device-item {
            padding: 15px 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .device-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .device-item:hover::before {
            left: 100%;
        }

        .device-item:hover {
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
            background: rgba(59, 130, 246, 0.05);
        }

        .device-item.selected {
            border-color: rgba(59, 130, 246, 0.4);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .device-item strong {
            display: block;
            color: #e0e0e0;
            font-size: 1.1em;
            font-weight: 600;
        }

        .device-item small {
            color: #b0b0b0;
            font-size: 0.9em;
        }

        .refresh-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.3s ease;
            color: #ffffff;
            margin-left: auto;
            position: relative;
        }

        .refresh-icon:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .refresh-icon:active {
            transform: scale(0.9);
        }

        .refresh-icon.spinning svg {
            animation: spin 1s linear infinite;
        }

        /* Video Element Styling */
        .video-element {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 text-white">
    <!-- Header -->
    <header class="bg-black/20 backdrop-blur-sm border-b border-white/10 p-4">
        <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                Remote Lab Interface
            </h1>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                    <span class="text-sm text-gray-300">Connected</span>
                </div>
                <button class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg transition-all duration-200">
                    Emergency Stop
                </button>
            </div>
        </div>
    </header>

    <div class="flex h-[calc(100vh-80px)]">
        <!-- Left Panel - Device controls and hub controls -->
        <div class="w-1/3 p-6 space-y-6 overflow-y-auto">
            <!-- Device Control -->
            <div class="bg-white/5 backdrop-blur-sm rounded-xl p-6 border border-white/10">
                <h2 class="text-xl font-semibold mb-4 text-blue-300">
                    Device Control
                </h2>

                <!-- Device Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">
                        Select Device
                        <button class="refresh-icon ml-2" onclick="refreshDevices()" title="Refresh Devices">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                            </svg>
                        </button>
                    </label>
                    <div id="devicesList" class="device-list">
                        <div class="device-item">Loading devices...</div>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">
                        Upload Firmware
                    </label>
                    <div class="border-2 border-dashed border-white/20 rounded-lg p-6 text-center hover:border-blue-400/50 transition-colors cursor-pointer">
                        <input
                            type="file"
                            accept=".hex,.bin"
                            class="hidden"
                            id="firmware-upload"
                        />
                        <label for="firmware-upload" class="cursor-pointer">
                            <div class="text-gray-400 mb-2">
                                <svg
                                    class="w-8 h-8 mx-auto mb-2"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                                    />
                                </svg>
                            </div>
                            <p>Drop HEX/BIN file here or click to browse</p>
                            <p class="text-xs text-gray-500 mt-1">
                                Supports .hex and .bin files
                            </p>
                        </label>
                    </div>
                </div>

                <!-- Flash Button & Progress -->
                <div class="space-y-3">
                    <button class="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-[1.02]">
                        Flash Device
                    </button>

                    <!-- Progress Bar -->
                    <div class="bg-black/30 rounded-full h-3 overflow-hidden">
                        <div
                            class="bg-gradient-to-r from-green-400 to-blue-400 h-full w-0 transition-all duration-500 ease-out"
                            style="width: 0%"
                        ></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>Status: Ready</span>
                        <span>0% Complete</span>
                    </div>
                </div>
            </div>

            <!-- Serial Monitor -->
            <div class="bg-white/5 backdrop-blur-sm rounded-xl p-6 border border-white/10">
                <h2 class="text-xl font-semibold mb-4 text-blue-300">
                    Serial Monitor
                </h2>

                <!-- Serial Controls -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <select class="bg-black/30 border border-white/20 rounded-lg px-3 py-2 focus:border-blue-400 focus:outline-none transition-colors">
                        <option>9600</option>
                        <option>115200</option>
                        <option>57600</option>
                        <option>38400</option>
                    </select>
                    <button id="serialToggleBtn" class="bg-green-500/20 hover:bg-green-500/30 border border-green-500/50 rounded-lg py-2 transition-all duration-200">
                        Connect
                    </button>
                </div>

                <!-- Terminal -->
                <div id="serialTerminal" class="bg-black/50 rounded-lg p-4 h-48 overflow-y-auto font-mono text-sm mb-4 border border-white/10">
                    <div class="text-gray-500 italic">[Not connected - Select a device and click Connect]</div>
                </div>

                <!-- Command Input -->
                <div class="flex space-x-2">
                    <input
                        type="text"
                        placeholder="Enter command..."
                        class="flex-1 bg-black/30 border border-white/20 rounded-lg px-3 py-2 focus:border-blue-400 focus:outline-none transition-colors"
                    />
                    <button class="bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/50 rounded-lg px-4 py-2 transition-all duration-200">
                        Send
                    </button>
                </div>
            </div>

            <!-- Hub Controls -->
            <div class="bg-white/5 backdrop-blur-sm rounded-xl p-6 border border-white/10">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-blue-300">Hub Controls</h2>
                    <button class="bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/50 rounded-lg px-3 py-1 text-sm transition-all duration-200">
                        + Add Control
                    </button>
                </div>

                <!-- Dynamic Controls Container -->
                <div class="space-y-4">
                    <!-- Controls will be dynamically added here -->
                </div>
            </div>
        </div>

        <!-- Right Panel - Video stream and oscilloscope -->
        <div class="w-2/3 p-6 space-y-6 overflow-y-auto">
            <!-- Video Stream -->
            <div class="bg-white/5 backdrop-blur-sm rounded-xl p-6 border border-white/10">
                <h2 class="text-xl font-semibold mb-4 text-blue-300">
                    Live Video Stream
                </h2>
                <div class="relative bg-black rounded-lg overflow-hidden group cursor-pointer" style="padding-bottom: 56.25%; position: relative;">
                    <div id="videoPlaceholder" class="absolute inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg
                                    class="w-8 h-8 text-blue-400"
                                    fill="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path d="M8 5v14l11-7z" />
                                </svg>
                            </div>
                            <p class="text-gray-400">Video Stream Offline</p>
                            <p class="text-xs text-gray-500 mt-1">Hover to start streaming</p>
                        </div>
                    </div>
                    <img id="videoElement" class="video-element" alt="Live Video Stream" style="display: none;">

                    <!-- Video Controls Overlay -->
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <button id="videoPlayBtn" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 -ml-16 bg-white/20 hover:bg-white/30 rounded-full p-3 transition-all duration-200" title="Start Video Stream">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </button>
                        <button id="videoStopBtn" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 -ml-16 bg-white/20 hover:bg-white/30 rounded-full p-3 transition-all duration-200 opacity-0 pointer-events-none" title="Stop Video Stream">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                            </svg>
                        </button>
                        <button id="audioMuteBtn" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 ml-16 bg-white/20 hover:bg-white/30 rounded-full p-3 transition-all duration-200" title="Start Audio Stream">
                            <svg
                                class="w-6 h-6"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M6.343 6.343a9 9 0 000 12.728m2.829-9.9a5 5 0 000 7.072"
                                />
                            </svg>
                        </button>
                        <button id="audioStopBtn" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 ml-16 bg-white/20 hover:bg-white/30 rounded-full p-3 transition-all duration-200 opacity-0 pointer-events-none" title="Stop Audio Stream">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5.5 9v6h2l3 3V6l-3 3H5.5z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Oscilloscope -->
            <div class="bg-white/5 backdrop-blur-sm rounded-xl p-6 border border-white/10 flex-1">
                <!-- Oscilloscope Header -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-blue-300">Oscilloscope</h2>
                    <div class="flex space-x-2">
                        <button class="bg-green-500/20 hover:bg-green-500/30 border border-green-500/50 rounded-lg px-3 py-1 text-sm transition-all duration-200">
                            Start
                        </button>
                        <button class="bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg px-3 py-1 text-sm transition-all duration-200">
                            Stop
                        </button>
                        <button class="bg-yellow-500/20 hover:bg-yellow-500/30 border border-red-500/50 rounded-lg px-3 py-1 text-sm transition-all duration-200">
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Oscilloscope Controls -->
                <div id="oscilloscopeControls" class="flex gap-4 mb-2">
                    <!-- Timebase Control -->
                    <div id="timebaseControl" class="p-2">
                        <label class="block text-xs font-medium mb-0.5">
                            Time-base: 10ms/div
                        </label>
                        <input
                            type="range"
                            min="0"
                            max="100"
                            value="50"
                            class="w-40 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider"
                        />
                    </div>

                    <!-- Amplitude Control -->
                    <div id="amplitudeControl" class="p-2">
                        <label class="block text-xs font-medium mb-0.5">
                            Amplude: 2V/div
                        </label>
                        <input
                            type="range"
                            min="0"
                            max="100"
                            value="25"
                            class="w-40 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider"
                        />
                    </div>

                    <!-- GPIO Channel Selection -->
                    <div id="gpioChannelControl" class="p-2">
                        <label class="block text-xs font-medium mb-0.5">GPIO Channel</label>
                        <select class="w-32 bg-black/30 border border-white/20 rounded px-2 py-0.5 text-sm focus:border-blue-400 focus:outline-none transition-colors">
                            <option>Channel 1</option>
                            <option>Channel 2</option>
                            <option>Both</option>
                        </select>
                    </div>
                </div>

                <!-- Slide Carousel -->
                <div class="flex items-center justify-between mb-3">
                    <div id="slideCarousel" class="flex space-x-2">
                        <button class="w-8 h-8 rounded text-sm transition-all duration-200 bg-blue-500/30 border border-blue-500/50 text-blue-300">
                            1
                        </button>
                    </div>
                    <button id="addSlideBtn" class="bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/50 rounded px-3 py-1 text-sm transition-all duration-200">
                        + Add Slide
                    </button>
                </div>

                <!-- Current Slide Info -->
                <div class="mb-4 text-sm text-gray-300">
                    <span class="font-medium text-blue-300">GPIO Analysis</span>
                    <span class="ml-2 text-xs bg-gray-700 px-2 py-1 rounded">GPIO</span>
                </div>

                <!-- Oscilloscope Display -->
                <div class="bg-black rounded-lg p-4 h-80 border border-white/10 relative overflow-hidden">
                    <!-- Grid Background -->
                    <div class="absolute inset-0 opacity-30">
                        <svg class="w-full h-full">
                            <defs>
                                <pattern
                                    id="smallGrid"
                                    width="20"
                                    height="20"
                                    patternUnits="userSpaceOnUse"
                                >
                                    <path
                                        d="M 20 0 L 0 0 0 20"
                                        fill="none"
                                        stroke="#374151"
                                        stroke-width="0.5"
                                    />
                                </pattern>
                                <pattern
                                    id="grid"
                                    width="100"
                                    height="100"
                                    patternUnits="userSpaceOnUse"
                                >
                                    <rect width="100" height="100" fill="url(#smallGrid)" />
                                    <path
                                        d="M 100 0 L 0 0 0 100"
                                        fill="none"
                                        stroke="#4B5563"
                                        stroke-width="1"
                                    />
                                </pattern>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#grid)" />
                        </svg>
                    </div>

                    <!-- Center Lines -->
                    <div class="absolute inset-0">
                        <div class="absolute top-1/2 left-0 right-0 h-px bg-yellow-400/50"></div>
                        <div class="absolute left-1/2 top-0 bottom-0 w-px bg-yellow-400/50"></div>
                    </div>

                    <!-- Waveforms -->
                    <svg class="absolute inset-0 w-full h-full">
                        <!-- GPIO Digital Signals -->
                        <path
                            d="M 0 100 L 50 100 L 50 50 L 100 50 L 100 100 L 150 100 L 150 50 L 200 50 L 200 100 L 250 100 L 250 50 L 300 50 L 300 100 L 350 100 L 350 50 L 400 50 L 400 100 L 450 100 L 450 50 L 500 50"
                            fill="none"
                            stroke="#10B981"
                            stroke-width="3"
                            class="animate-pulse"
                        />
                        <path
                            d="M 0 200 L 30 200 L 30 150 L 80 150 L 80 200 L 120 200 L 120 150 L 170 150 L 170 200 L 220 200 L 220 150 L 270 150 L 270 200 L 320 200 L 320 150 L 370 150 L 370 200 L 420 200 L 420 150 L 500 150"
                            fill="none"
                            stroke="#3B82F6"
                            stroke-width="3"
                            class="animate-pulse"
                            style="animation-delay: 0.5s"
                        />
                    </svg>

                    <!-- Channel Labels -->
                    <div class="absolute top-2 left-2 space-y-1">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                            <span class="text-xs text-green-400">GPIO_0 (Digital)</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                            <span class="text-xs text-blue-400">GPIO_1 (Digital)</span>
                        </div>
                    </div>

                    <!-- Measurements -->
                    <div class="absolute top-2 right-2 text-xs space-y-1">
                        <div class="text-green-400">Frequency: 1.2kHz</div>
                        <div class="text-blue-400">Duty Cycle: 50%</div>
                        <div class="text-yellow-400">High: 3.3V</div>
                    </div>

                    <!-- Trigger Indicator -->
                    <div class="absolute bottom-2 left-2">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-red-400 rounded-full animate-pulse"></div>
                            <span class="text-xs text-red-400">Triggered</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket = null;
        let selectedDevice = null;
        let currentFirmware = null;
        let currentSlide = 1;
        let totalSlides = 1;
        let slides = [{ type: 'gpio', name: 'GPIO Logic Analyzer' }];
        let hubControls = [];

        // Initialize SocketIO connection
        function initSocket() {
            try {
                socket = io();
                console.log('Socket.IO initialized');

                socket.on('connect', function() {
                    console.log('Connected to server');
                });

                socket.on('disconnect', function() {
                    console.log('Disconnected from server');
                });

                // Handle flash progress updates
                socket.on('flash_progress', function(data) {
                    updateFlashProgress(data.progress, data.status, data.in_progress);
                });

                // Handle video frame updates
                socket.on('video_frame', function(data) {
                    updateVideoFrame(data.frame);
                });

                // Handle serial data
                socket.on('serial_data', function(data) {
                    addToSerialTerminal(data.data);
                });

                socket.on('serial_status', function(data) {
                    updateSerialStatus(data);
                });

                // Handle streaming status updates
                socket.on('streaming_status', function(data) {
                    console.log('Streaming status:', data);
                    if (data.type === 'video') {
                        if (data.status === 'started') {
                            console.log('Video streaming started');
                            showVideoElement();
                            // Update button states
                            toggleVideoButtons(true);
                        } else if (data.status === 'stopped') {
                            console.log('Video streaming stopped');
                            hideVideoElement();
                            // Update button states
                            toggleVideoButtons(false);
                        } else if (data.status === 'error') {
                            alert('Video streaming error: ' + (data.message || 'Unknown error'));
                            hideVideoElement();
                            // Reset button states on error
                            toggleVideoButtons(false);
                        }
                    } else if (data.type === 'audio') {
                        if (data.status === 'started') {
                            console.log('Audio streaming started');
                            // Update button states
                            toggleAudioButtons(true);
                        } else if (data.status === 'stopped') {
                            console.log('Audio streaming stopped');
                            // Update button states
                            toggleAudioButtons(false);
                        } else if (data.status === 'error') {
                            alert('Audio streaming error: ' + (data.message || 'Unknown error'));
                            // Reset button states on error
                            toggleAudioButtons(false);
                        }
                    } else if (data.type === 'all') {
                        if (data.status === 'stopped') {
                            console.log('All streaming stopped');
                            hideVideoElement();
                            // Reset all button states
                            toggleVideoButtons(false);
                            toggleAudioButtons(false);
                        }
                    }
                });

                // Hub Controls event handlers
                socket.on('hub_controls_cleared', function(data) {
                    console.log('Hub controls cleared');
                    // Clear all existing controls from UI
                    clearAllHubControls();
                });

                socket.on('hub_controls_detected', function(data) {
                    console.log('Hub controls detected:', data.values);
                    // Auto-create reader controls for detected values
                    data.values.forEach(valueName => {
                        createHubControlUI(valueName, 'reader');
                    });
                });

                socket.on('hub_commands_detected', function(data) {
                    console.log('Hub commands detected:', data.commands);
                    // Update global detected commands
                    window.detectedCommands = new Set(data.commands);
                    // Re-render existing controls to update dropdowns
                    hubControls.forEach(control => {
                        if (control.type === 'toggle') {
                            renderHubControl(control);
                        }
                    });
                });

                socket.on('hub_control_created', function(data) {
                    console.log('Hub control created:', data.control);
                    hubControls.push(data.control);
                    renderHubControl(data.control);
                });

                socket.on('hub_control_updated', function(data) {
                    console.log('Hub control updated:', data.control);
                    updateHubControlUI(data.control);
                });

                socket.on('hub_control_deleted', function(data) {
                    console.log('Hub control deleted:', data.control);
                    removeHubControlUI(data.control.id);
                });

                socket.on('control_command_sent', function(data) {
                    console.log('Control command sent:', data);
                    updateControlValueDisplay(data.id, data.value);
                });

                socket.on('hub_control_error', function(data) {
                    console.error('Hub control error:', data.message);
                    alert('Hub Control Error: ' + data.message);
                });

            } catch (error) {
                console.error('Failed to initialize Socket.IO:', error);
                alert('Failed to connect to server. Please refresh the page.');
            }
        }

        // Flash progress bar update
        function updateFlashProgress(progress, status, inProgress) {
            const progressBar = document.querySelector('.bg-gradient-to-r.from-green-400.to-blue-400');
            const statusText = document.querySelector('.flex.justify-between.text-xs.text-gray-400 span:first-child');
            const percentText = document.querySelector('.flex.justify-between.text-xs.text-gray-400 span:last-child');
            const flashButton = document.querySelector('.bg-gradient-to-r.from-green-500.to-blue-500');

            if (progressBar) {
                progressBar.style.width = progress + '%';
            }

            if (statusText) {
                statusText.textContent = 'Status: ' + status;
            }

            if (percentText) {
                percentText.textContent = progress + '% Complete';
            }

            if (flashButton) {
                if (inProgress) {
                    flashButton.disabled = true;
                    flashButton.textContent = 'Flashing...';
                } else {
                    flashButton.disabled = false;
                    flashButton.textContent = 'Flash Device';
                }
            }
        }

        // Video frame update
        function updateVideoFrame(frameData) {
            const videoElement = document.getElementById('videoElement');
            const videoPlaceholder = document.getElementById('videoPlaceholder');

            if (videoElement && frameData) {
                videoElement.src = 'data:image/jpeg;base64,' + frameData;
                videoElement.style.display = 'block';
                if (videoPlaceholder) {
                    videoPlaceholder.style.display = 'none';
                }
            }
        }

        // Show video element and hide placeholder
        function showVideoElement() {
            const videoElement = document.getElementById('videoElement');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            if (videoElement) {
                videoElement.style.display = 'block';
            }
            if (videoPlaceholder) {
                videoPlaceholder.style.display = 'none';
            }
        }

        // Hide video element and show placeholder
        function hideVideoElement() {
            const videoElement = document.getElementById('videoElement');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            if (videoElement) {
                videoElement.style.display = 'none';
            }
            if (videoPlaceholder) {
                videoPlaceholder.style.display = 'flex';
            }
        }

        // Serial terminal functions
        function addToSerialTerminal(data) {
            const terminal = document.getElementById('serialTerminal');
            if (terminal) {
                const line = document.createElement('div');
                line.className = 'text-green-400';
                line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + data;
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;

                // Update serial values for plotting when new data arrives
                updateSerialValues();
            }
        }

        function updateSerialStatus(data) {
            console.log('Serial status:', data);
            const toggleBtn = document.getElementById('serialToggleBtn');

            if (data.status === 'started') {
                if (toggleBtn) {
                    toggleBtn.textContent = 'Disconnect';
                    toggleBtn.className = 'bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg py-2 transition-all duration-200';
                }
                // Clear sample data when connecting
                const terminal = document.getElementById('serialTerminal');
                if (terminal) {
                    terminal.innerHTML = '<div class="text-green-400">[System] Serial monitor connected</div>';
                }
            } else if (data.status === 'stopped') {
                if (toggleBtn) {
                    toggleBtn.textContent = 'Connect';
                    toggleBtn.className = 'bg-green-500/20 hover:bg-green-500/30 border border-green-500/50 rounded-lg py-2 transition-all duration-200';
                }
                // Add disconnection message
                const terminal = document.getElementById('serialTerminal');
                if (terminal) {
                    const line = document.createElement('div');
                    line.className = 'text-yellow-400';
                    line.textContent = '[' + new Date().toLocaleTimeString() + '] [System] Serial monitor disconnected';
                    terminal.appendChild(line);
                    terminal.scrollTop = terminal.scrollHeight;
                }
            } else if (data.status === 'error') {
                alert('Serial error: ' + data.message);
                if (toggleBtn) {
                    toggleBtn.textContent = 'Connect';
                    toggleBtn.className = 'bg-green-500/20 hover:bg-green-500/30 border border-green-500/50 rounded-lg py-2 transition-all duration-200';
                }
            }
        }

        // Device management functions
        function refreshDevices() {
            // Add spinning animation
            const refreshIcon = document.querySelector('.refresh-icon');
            if (refreshIcon) {
                refreshIcon.classList.add('spinning');
            }

            fetch('/devices')
                .then(response => response.json())
                .then(data => {
                    const devicesList = document.getElementById('devicesList');
                    if (data.devices.length === 0) {
                        devicesList.innerHTML = '<div class="device-item">No devices detected</div>';
                        updateFlashButtonState();
                    } else {
                        devicesList.innerHTML = '';
                        data.devices.forEach(device => {
                            const deviceItem = document.createElement('div');
                            deviceItem.className = 'device-item';
                            deviceItem.onclick = () => selectDevice(deviceItem, device);
                            deviceItem.innerHTML = `<strong>${device[2]}</strong><br><small>${device[1]}</small>`;
                            devicesList.appendChild(deviceItem);
                        });
                        updateFlashButtonState();
                    }
                })
                .catch(error => {
                    console.error('Error fetching devices:', error);
                    document.getElementById('devicesList').innerHTML = '<div class="device-item">Error loading devices</div>';
                    updateFlashButtonState();
                })
                .finally(() => {
                    // Remove spinning animation after a short delay
                    setTimeout(() => {
                        if (refreshIcon) {
                            refreshIcon.classList.remove('spinning');
                        }
                    }, 500);
                });
        }

        function selectDevice(item, device) {
            // Remove previous selection
            document.querySelectorAll('.device-item').forEach(i => i.classList.remove('selected'));
            // Add selection to clicked item
            item.classList.add('selected');
            item.setAttribute('data-device', JSON.stringify(device));
            selectedDevice = device;
            updateFlashButtonState();
        }

        function updateFlashButtonState() {
            const flashButton = document.querySelector('.bg-gradient-to-r.from-green-500.to-blue-500');
            if (flashButton) {
                flashButton.disabled = !selectedDevice || !currentFirmware;
            }
        }

        // Flash button click handler
        function setupFlashButton() {
            const flashButton = document.querySelector('.bg-gradient-to-r.from-green-500.to-blue-500');
            if (flashButton) {
                flashButton.addEventListener('click', function() {
                    if (!selectedDevice || !currentFirmware) {
                        alert('Please select a device and upload firmware first');
                        return;
                    }

                    // Send flash request using selected device data
                    fetch('/flash', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'device_type': selectedDevice[0],
                            'port': selectedDevice[1],
                            'chip_type': selectedDevice[3]
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Flash started:', data);
                    })
                    .catch(error => {
                        console.error('Flash error:', error);
                        alert('Failed to start flashing process');
                    });
                });
            }
        }

        // File upload handler
        function setupFileUpload() {
            const fileInput = document.getElementById('firmware-upload');
            if (fileInput) {
                fileInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const formData = new FormData();
                    formData.append('file', file);

                    fetch('/upload', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Upload error: ' + data.error);
                        } else {
                            currentFirmware = data.filename;
                            alert('File uploaded successfully!');
                            updateFlashButtonState();
                        }
                    })
                    .catch(error => {
                        console.error('Upload error:', error);
                        alert('Upload failed!');
                    });
                });
            }
        }

        // Serial monitor functions
        function setupSerialControls() {
            const toggleBtn = document.getElementById('serialToggleBtn');
            const sendBtn = document.querySelector('.bg-blue-500\\/20');
            const commandInput = document.querySelector('input[placeholder="Enter command..."]');
            const baudSelect = document.querySelector('select');

            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    const isConnected = toggleBtn.textContent === 'Disconnect';

                    if (isConnected) {
                        // Disconnect
                        socket.emit('stop_serial_monitor');
                    } else {
                        // Connect
                        const selectedDevice = document.querySelector('.device-item.selected');
                        if (!selectedDevice) {
                            alert('Please select a device first');
                            return;
                        }

                        const deviceData = selectedDevice.getAttribute('data-device');
                        if (!deviceData) {
                            alert('Device data not available');
                            return;
                        }

                        const device = JSON.parse(deviceData);
                        const baudrate = baudSelect ? parseInt(baudSelect.value) : 9600;

                        socket.emit('start_serial_monitor', {
                            port: device[1], // port
                            baudrate: baudrate
                        });
                    }
                });
            }

            if (sendBtn && commandInput) {
                sendBtn.addEventListener('click', function() {
                    const command = commandInput.value.trim();
                    if (command) {
                        socket.emit('send_serial_data', {data: command});
                        commandInput.value = '';
                    }
                });

                commandInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const command = commandInput.value.trim();
                        if (command) {
                            socket.emit('send_serial_data', {data: command});
                            commandInput.value = '';
                        }
                    }
                });
            }
        }

        // Helper functions for button toggling
        function toggleVideoButtons(showStop) {
            const videoPlayBtn = document.getElementById('videoPlayBtn');
            const videoStopBtn = document.getElementById('videoStopBtn');

            if (showStop) {
                // Show stop button, hide play button
                if (videoPlayBtn) {
                    videoPlayBtn.style.opacity = '0';
                    videoPlayBtn.style.pointerEvents = 'none';
                }
                if (videoStopBtn) {
                    videoStopBtn.style.opacity = '1';
                    videoStopBtn.style.pointerEvents = 'auto';
                }
            } else {
                // Show play button, hide stop button
                if (videoPlayBtn) {
                    videoPlayBtn.style.opacity = '1';
                    videoPlayBtn.style.pointerEvents = 'auto';
                }
                if (videoStopBtn) {
                    videoStopBtn.style.opacity = '0';
                    videoStopBtn.style.pointerEvents = 'none';
                }
            }
        }

        function toggleAudioButtons(showStop) {
            const audioMuteBtn = document.getElementById('audioMuteBtn');
            const audioStopBtn = document.getElementById('audioStopBtn');

            if (showStop) {
                // Show stop button, hide start button
                if (audioMuteBtn) {
                    audioMuteBtn.style.opacity = '0';
                    audioMuteBtn.style.pointerEvents = 'none';
                }
                if (audioStopBtn) {
                    audioStopBtn.style.opacity = '1';
                    audioStopBtn.style.pointerEvents = 'auto';
                }
            } else {
                // Show start button, hide stop button
                if (audioMuteBtn) {
                    audioMuteBtn.style.opacity = '1';
                    audioMuteBtn.style.pointerEvents = 'auto';
                }
                if (audioStopBtn) {
                    audioStopBtn.style.opacity = '0';
                    audioStopBtn.style.pointerEvents = 'none';
                }
            }
        }

        // Video and audio streaming controls
        function setupStreamingControls() {
            const videoPlayBtn = document.getElementById('videoPlayBtn');
            const videoStopBtn = document.getElementById('videoStopBtn');
            const audioMuteBtn = document.getElementById('audioMuteBtn');
            const audioStopBtn = document.getElementById('audioStopBtn');

            // Video play button
            if (videoPlayBtn) {
                videoPlayBtn.addEventListener('click', function() {
                    if (socket && socket.connected) {
                        socket.emit('start_streaming', {video: true, audio: false});
                        // Show stop button, hide play button
                        toggleVideoButtons(true);
                    } else {
                        alert('Not connected to server');
                    }
                });
            }

            // Video stop button
            if (videoStopBtn) {
                videoStopBtn.addEventListener('click', function() {
                    if (socket && socket.connected) {
                        socket.emit('stop_streaming');
                        // Show play button, hide stop button
                        toggleVideoButtons(false);
                    } else {
                        alert('Not connected to server');
                    }
                });
            }

            // Audio start button
            if (audioMuteBtn) {
                audioMuteBtn.addEventListener('click', function() {
                    if (socket && socket.connected) {
                        socket.emit('start_streaming', {video: false, audio: true});
                        // Show stop button, hide start button
                        toggleAudioButtons(true);
                    } else {
                        alert('Not connected to server');
                    }
                });
            }

            // Audio stop button
            if (audioStopBtn) {
                audioStopBtn.addEventListener('click', function() {
                    if (socket && socket.connected) {
                        socket.emit('stop_streaming');
                        // Show start button, hide stop button
                        toggleAudioButtons(false);
                    } else {
                        alert('Not connected to server');
                    }
                });
            }
        }

        // Slide management functions
        function updateSlideCarousel() {
            console.log('updateSlideCarousel called, totalSlides:', totalSlides);
            const carousel = document.getElementById('slideCarousel');
            const addButton = document.getElementById('addSlideBtn');

            if (!carousel) {
                console.error('slideCarousel element not found');
                return;
            }

            // Clear existing buttons
            carousel.innerHTML = '';

            // Create slide buttons
            for (let i = 1; i <= totalSlides; i++) {
                const button = document.createElement('button');
                button.className = `w-8 h-8 rounded text-sm transition-all duration-200 ${
                    i === currentSlide
                        ? 'bg-blue-500/30 border border-blue-500/50 text-blue-300'
                        : 'bg-white/10 hover:bg-white/20 border border-white/20 text-gray-400'
                }`;
                button.textContent = i;
                button.onclick = () => switchToSlide(i);
                carousel.appendChild(button);
            }

            // Update add button state
            if (addButton) {
                addButton.disabled = totalSlides >= 5;
                addButton.style.opacity = totalSlides >= 5 ? '0.5' : '1';
                // Remove existing event listeners
                addButton.removeEventListener('click', addSerialPlotSlide);
                // Add event listener if not at max slides
                if (totalSlides < 5) {
                    addButton.addEventListener('click', addSerialPlotSlide);
                }
            }

            updateSlideDisplay();
        }

        function switchToSlide(slideNumber) {
            currentSlide = slideNumber;
            updateSlideCarousel();
            updateControlsForSlide();
        }

        function addSerialPlotSlide() {
            if (totalSlides >= 5) return;

            totalSlides++;
            slides.push({
                type: 'serial',
                name: `Serial Plot ${totalSlides}`
            });

            switchToSlide(totalSlides);
        }

        function updateSlideDisplay() {
            const slideInfo = document.querySelector('.mb-4.text-sm.text-gray-300');
            const currentSlideData = slides[currentSlide - 1];

            if (slideInfo && currentSlideData) {
                slideInfo.innerHTML = `
                    <span class="font-medium text-blue-300">${currentSlideData.name}</span>
                    <span class="ml-2 text-xs bg-gray-700 px-2 py-1 rounded">${currentSlideData.type.toUpperCase()}</span>
                `;
            }
        }

        function updateControlsForSlide() {
            const currentSlideData = slides[currentSlide - 1];
            const controlsContainer = document.getElementById('oscilloscopeControls');

            if (currentSlideData.type === 'gpio') {
                // GPIO Logic Analyzer controls - Natural flex layout, no wasted space
                controlsContainer.className = 'flex gap-4 mb-2';
                controlsContainer.innerHTML = `
                    <!-- Timebase Control -->
                    <div id="timebaseControl" class="p-2">
                        <label class="block text-xs font-medium mb-0.5">
                            Time-base: 10ms/div
                        </label>
                        <input
                            type="range"
                            min="0"
                            max="100"
                            value="50"
                            class="w-40 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider"
                        />
                    </div>

                    <!-- Amplitude Control -->
                    <div id="amplitudeControl" class="p-2">
                        <label class="block text-xs font-medium mb-0.5">
                            Amplude: 2V/div
                        </label>
                        <input
                            type="range"
                            min="0"
                            max="100"
                            value="25"
                            class="w-40 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider"
                        />
                    </div>

                    <!-- GPIO Channel Selection -->
                    <div id="gpioChannelControl" class="p-2">
                        <label class="block text-xs font-medium mb-0.5">GPIO Channel</label>
                        <select class="w-32 bg-black/30 border border-white/20 rounded px-2 py-0.5 text-sm focus:border-blue-400 focus:outline-none transition-colors">
                            <option>Channel 1</option>
                            <option>Channel 2</option>
                            <option>Both</option>
                        </select>
                    </div>
                `;
            } else if (currentSlideData.type === 'serial') {
                // Serial Plot controls - Top row: dropdowns, Bottom row: scales
                controlsContainer.className = 'space-y-2 mb-2';
                controlsContainer.innerHTML = `
                    <!-- Top Row - Dropdown Controls -->
                    <div class="flex gap-1">
                        <!-- Baud Rate Control -->
                        <div id="baudRateControl" class="p-0.5">
                            <label class="block text-xs font-medium mb-0.5">Baud-rate</label>
                            <select class="w-24 bg-black/30 border border-white/20 rounded px-2 py-0.5 text-sm focus:border-blue-400 focus:outline-none transition-colors">
                                <option>9600</option>
                                <option>19200</option>
                                <option>38400</option>
                                <option>57600</option>
                                <option>115200</option>
                            </select>
                        </div>

                        <!-- CH1 Value Control -->
                        <div id="ch1ValueControl" class="p-0.5">
                            <label class="block text-xs font-medium mb-0.5">CH1-Value</label>
                            <select id="serialValueSelectCH1" class="w-24 bg-black/30 border border-white/20 rounded px-2 py-0.5 text-sm focus:border-blue-400 focus:outline-none transition-colors">
                                <option>Loading...</option>
                            </select>
                        </div>

                        <!-- CH2 Value Control -->
                        <div id="ch2ValueControl" class="p-0.5">
                            <label class="block text-xs font-medium mb-0.5">CH2-value</label>
                            <select id="serialValueSelectCH2" class="w-24 bg-black/30 border border-white/20 rounded px-2 py-0.5 text-sm focus:border-blue-400 focus:outline-none transition-colors">
                                <option>Loading...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Bottom Row - Scale Controls -->
                    <div class="grid grid-cols-2 gap-2">
                        <!-- Amplitude Control -->
                        <div id="amplitudeControl" class="p-0">
                            <label class="block text-xs font-medium mb-0">
                                Amplitude: 2V/div
                            </label>
                            <input
                                type="range"
                                min="0"
                                max="100"
                                value="25"
                                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider"
                            />
                        </div>

                        <!-- Timebase Control -->
                        <div id="timebaseControl" class="p-0">
                            <label class="block text-xs font-medium mb-0">
                                Timebase: 100ms/div
                            </label>
                            <input
                                type="range"
                                min="0"
                                max="100"
                                value="50"
                                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider"
                            />
                        </div>
                    </div>
                `;

                // Initialize serial value detection
                updateSerialValues();
            }

            updateWaveformDisplay();
        }

        function updateWaveformDisplay() {
            const currentSlideData = slides[currentSlide - 1];
            const svgElement = document.querySelector('svg.absolute.inset-0.w-full.h-full');
            const channelLabels = document.querySelector('.absolute.top-2.left-2.space-y-1');
            const measurements = document.querySelector('.absolute.top-2.right-2.text-xs.space-y-1');

            if (currentSlideData.type === 'gpio') {
                // GPIO Logic Analyzer display
                if (svgElement) {
                    svgElement.innerHTML = `
                        <!-- GPIO Digital Signals -->
                        <path
                            d="M 0 100 L 50 100 L 50 50 L 100 50 L 100 100 L 150 100 L 150 50 L 200 50 L 200 100 L 250 100 L 250 50 L 300 50 L 300 100 L 350 100 L 350 50 L 400 50 L 400 100 L 450 100 L 450 50 L 500 50"
                            fill="none"
                            stroke="#10B981"
                            stroke-width="3"
                            class="animate-pulse"
                        />
                        <path
                            d="M 0 200 L 30 200 L 30 150 L 80 150 L 80 200 L 120 200 L 120 150 L 170 150 L 170 200 L 220 200 L 220 150 L 270 150 L 270 200 L 320 200 L 320 150 L 370 150 L 370 200 L 420 200 L 420 150 L 500 150"
                            fill="none"
                            stroke="#3B82F6"
                            stroke-width="3"
                            class="animate-pulse"
                            style="animation-delay: 0.5s"
                        />
                    `;
                }

                if (channelLabels) {
                    channelLabels.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                            <span class="text-xs text-green-400">GPIO_0 (Digital)</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                            <span class="text-xs text-blue-400">GPIO_1 (Digital)</span>
                        </div>
                    `;
                }

                if (measurements) {
                    measurements.innerHTML = `
                        <div class="text-green-400">Frequency: 1.2kHz</div>
                        <div class="text-blue-400">Duty Cycle: 50%</div>
                        <div class="text-yellow-400">High: 3.3V</div>
                    `;
                }
            } else if (currentSlideData.type === 'serial') {
                // Serial Plot display
                if (svgElement) {
                    svgElement.innerHTML = `
                        <!-- Serial Plot - Analog waveform -->
                        <path
                            d="M 0 200 Q 25 180 50 160 T 100 140 Q 125 120 150 100 T 200 80 Q 225 60 250 40 T 300 20 Q 325 40 350 60 T 400 80 Q 425 100 450 120 T 500 140"
                            fill="none"
                            stroke="#8B5CF6"
                            stroke-width="3"
                            class="animate-pulse"
                        />
                        <path
                            d="M 0 250 Q 30 230 60 210 T 120 190 Q 150 170 180 150 T 240 130 Q 270 110 300 90 T 360 70 Q 390 90 420 110 T 480 130"
                            fill="none"
                            stroke="#F59E0B"
                            stroke-width="3"
                            class="animate-pulse"
                            style="animation-delay: 0.3s"
                        />
                    `;
                }

                if (channelLabels) {
                    channelLabels.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-purple-400 rounded-full"></div>
                            <span class="text-xs text-purple-400">Serial_CH1 (Analog)</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                            <span class="text-xs text-yellow-400">Serial_CH2 (Analog)</span>
                        </div>
                    `;
                }

                if (measurements) {
                    measurements.innerHTML = `
                        <div class="text-purple-400">Peak: 4.2V</div>
                        <div class="text-yellow-400">RMS: 2.1V</div>
                        <div class="text-cyan-400">Sample Rate: 9600bps</div>
                    `;
                }
            }
        }

        // Serial value detection for plotting
        function updateSerialValues() {
            const terminal = document.getElementById('serialTerminal');
            const selectElementCH1 = document.getElementById('serialValueSelectCH1');
            const selectElementCH2 = document.getElementById('serialValueSelectCH2');

            if (!terminal || !selectElementCH1 || !selectElementCH2) return;

            // Get all terminal text
            const terminalText = terminal.textContent || '';

            // Regex patterns to detect common sensor values
            const patterns = [
                // Temperature patterns
                /(?:temp|temperature|temp_c|temp_f)[\s:]*([+-]?\d*\.?\d+)/gi,
                // RPM patterns
                /(?:rpm|speed|velocity)[\s:]*([+-]?\d*\.?\d+)/gi,
                // Voltage patterns
                /(?:volt|voltage|v|adc)[\s:]*([+-]?\d*\.?\d+)/gi,
                // Current patterns
                /(?:current|amp|amps|i)[\s:]*([+-]?\d*\.?\d+)/gi,
                // Pressure patterns
                /(?:press|pressure|psi|bar)[\s:]*([+-]?\d*\.?\d+)/gi,
                // Distance/Position patterns
                /(?:dist|distance|pos|position|cm|mm|inch)[\s:]*([+-]?\d*\.?\d+)/gi,
                // Generic numeric values with labels
                /([a-zA-Z_]+)[\s:]*([+-]?\d*\.?\d+)/g
            ];

            const detectedValues = new Set();

            // Extract values using patterns
            patterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(terminalText)) !== null) {
                    const label = match[1].toLowerCase().trim();
                    if (label && label.length > 0 && !/^\d/.test(label)) {
                        // Clean up the label
                        let cleanLabel = label.replace(/[^a-zA-Z0-9_]/g, '');
                        if (cleanLabel.length > 0) {
                            detectedValues.add(cleanLabel);
                        }
                    }
                }
            });

            // Function to update a dropdown
            function updateDropdown(selectElement) {
                selectElement.innerHTML = '<option value="">Select Value</option>';

                if (detectedValues.size > 0) {
                    Array.from(detectedValues).sort().forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value.charAt(0).toUpperCase() + value.slice(1);
                        selectElement.appendChild(option);
                    });
                } else {
                    // No values detected
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No values detected';
                    option.disabled = true;
                    selectElement.appendChild(option);
                }
            }

            // Update both dropdowns
            updateDropdown(selectElementCH1);
            updateDropdown(selectElementCH2);
        }

        // Global variables for detected values
        window.serialValuePatterns = {};
        window.detectedCommands = new Set();

        // Hub Controls Functions
        function createHubControlUI(valueName, controlType) {
            if (!socket || !socket.connected) {
                alert('Not connected to server');
                return;
            }

            socket.emit('create_hub_control', {name: valueName, type: controlType});
        }

        function renderHubControl(control) {
            const controlsContainer = document.querySelector('.space-y-4');
            if (!controlsContainer) return;

            // Check if control already exists
            const existingControl = document.getElementById(`control-${control.id}`);
            if (existingControl) {
                updateHubControlUI(control);
                return;
            }

            // Create control element based on type
            let controlElement = '';

            if (control.type === 'slider') {
                // For sliders: 1 dropdown for input command
                const detectedValues = Object.keys(window.serialValuePatterns || {});
                const commandOptions = detectedValues.length > 0 ?
                    detectedValues.map(val => `<option value="${val}">${val}</option>`).join('') :
                    '<option value="">No commands detected</option>';

                controlElement = `
                    <div id="control-${control.id}" class="bg-black/20 rounded-lg p-4 border border-white/5 animate-fadeIn">
                        <div class="space-y-3">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-medium text-white">${control.name}</span>
                                        <button onclick="deleteHubControl('${control.id}')" class="bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded px-2 py-1 text-xs transition-all duration-200">
                                            
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Current Value Display -->
                            <div class="flex justify-center mb-2">
                                <span id="value-${control.id}" class="text-2xl font-mono text-blue-400 font-bold">${control.config.min || 0}${control.config.unit ? ' ' + control.config.unit : ''}</span>
                            </div>

                            <!-- Slider -->
                            <input
                                type="range"
                                min="${control.config.min}"
                                max="${control.config.max}"
                                step="${control.config.step}"
                                value="${control.config.min || 0}"
                                oninput="updateSliderValue('${control.id}', this.value); sendControlCommand('${control.id}', this.value)"
                                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider"
                            />

                            <!-- Min/Max Controls Inline -->
                            <div class="flex justify-between items-center text-xs">
                                <div class="flex items-center space-x-1">
                                    <span class="text-gray-400">Min:</span>
                                    <input
                                        type="number"
                                        value="${control.config.min}"
                                        onchange="updateSliderRange('${control.id}', 'min', this.value)"
                                        class="w-16 bg-black/30 border border-white/20 rounded px-2 py-1 text-xs focus:border-blue-400 focus:outline-none"
                                    >
                                </div>
                                <div class="flex items-center space-x-1">
                                    <span class="text-gray-400">Max:</span>
                                    <input
                                        type="number"
                                        value="${control.config.max}"
                                        onchange="updateSliderRange('${control.id}', 'max', this.value)"
                                        class="w-16 bg-black/30 border border-white/20 rounded px-2 py-1 text-xs focus:border-blue-400 focus:outline-none"
                                    >
                                </div>
                            </div>

                            <!-- Command Template -->
                            <div class="mt-3 pt-3 border-t border-white/10">
                                <label class="block text-xs font-medium mb-1 text-gray-400">
                                    Command Template
                                </label>
                                <input
                                    type="text"
                                    value="${control.config.command_template || `${control.name}={value}`}"
                                    onchange="updateControlCommand('${control.id}', this.value)"
                                    class="w-full bg-black/30 border border-white/20 rounded px-2 py-1 text-sm focus:border-blue-400 focus:outline-none transition-colors"
                                    placeholder="e.g., servo={value}"
                                >
                            </div>
                        </div>
                    </div>
                `;
            } else if (control.type === 'toggle') {
                // For toggles: 2 value inputs with dropdowns and confirm buttons
                const detectedCommands = Array.from(window.detectedCommands || []);
                const valueOptions = control.config.value_options || ['0', '1'];

                controlElement = `
                    <div id="control-${control.id}" class="bg-black/20 rounded-lg p-4 border border-white/5 animate-fadeIn">
                        <div class="space-y-3">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-medium text-white">${control.name}</span>
                                        <button onclick="deleteHubControl('${control.id}')" class="bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded px-2 py-1 text-xs transition-all duration-200">
                                            
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-300">Status</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" onchange="sendToggleCommand('${control.id}', this.checked)" class="sr-only peer" />
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                                </label>
                            </div>

                            <div class="mt-3 pt-3 border-t border-white/10">
                                <label class="block text-xs font-medium mb-1 text-gray-400">
                                    Value Options
                                </label>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Value 1</label>
                                    <div class="flex space-x-1">
                                        <select id="val1-select-${control.id}" class="flex-1 min-w-0 max-w-20 bg-black/30 border border-white/20 rounded px-2 py-1 text-xs focus:border-blue-400 focus:outline-none overflow-hidden text-ellipsis">
                                            <option value="${valueOptions[0]}" selected>${valueOptions[0]}</option>
                                            ${detectedCommands.map(cmd => `<option value="${cmd}">${cmd}</option>`).join('')}
                                        </select>
                                        <input
                                            type="text"
                                            id="val1-custom-${control.id}"
                                            placeholder="Custom..."
                                            class="flex-1 min-w-0 max-w-20 bg-black/30 border border-white/20 rounded px-2 py-1 text-xs focus:border-blue-400 focus:outline-none"
                                            onkeypress="handleCustomValueKeypress(event, '${control.id}', 0)"
                                        >
                                        <button onclick="confirmToggleValue('${control.id}', 0)" class="bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/50 rounded px-2 py-1 text-xs transition-all duration-200 flex-shrink-0">
                                            
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Value 2</label>
                                    <div class="flex space-x-1">
                                        <select id="val2-select-${control.id}" class="flex-1 min-w-0 max-w-20 bg-black/30 border border-white/20 rounded px-2 py-1 text-xs focus:border-blue-400 focus:outline-none overflow-hidden text-ellipsis">
                                            <option value="${valueOptions[1]}" selected>${valueOptions[1]}</option>
                                            ${detectedCommands.map(cmd => `<option value="${cmd}">${cmd}</option>`).join('')}
                                        </select>
                                        <input
                                            type="text"
                                            id="val2-custom-${control.id}"
                                            placeholder="Custom..."
                                            class="flex-1 min-w-0 max-w-20 bg-black/30 border border-white/20 rounded px-2 py-1 text-xs focus:border-blue-400 focus:outline-none"
                                            onkeypress="handleCustomValueKeypress(event, '${control.id}', 1)"
                                        >
                                        <button onclick="confirmToggleValue('${control.id}', 1)" class="bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/50 rounded px-2 py-1 text-xs transition-all duration-200 flex-shrink-0">
                                            
                                        </button>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (control.type === 'reader') {
                // For readers: Display-only controls that show current values
                controlElement = `
                    <div id="control-${control.id}" class="bg-black/20 rounded-lg p-4 border border-white/5 animate-fadeIn">
                        <div class="space-y-3">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-medium text-white">${control.name}</span>
                                        <button onclick="deleteHubControl('${control.id}')" class="bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded px-2 py-1 text-xs transition-all duration-200">
                                            
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Current Value Display -->
                            <div class="flex justify-center mb-2">
                                <span id="value-${control.id}" class="text-2xl font-mono text-green-400 font-bold">--${control.config.unit ? ' ' + control.config.unit : ''}</span>
                            </div>

                            <!-- Reader indicator -->
                            <div class="flex justify-center">
                                <div class="flex items-center space-x-2 text-sm text-gray-400">
                                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                    <span>Reading</span>
                                </div>
                            </div>

                            <!-- Command Template (for reference) -->
                            <div class="mt-3 pt-3 border-t border-white/10">
                                <label class="block text-xs font-medium mb-1 text-gray-400">
                                    Read Command
                                </label>
                                <input
                                    type="text"
                                    value="${control.config.command_template || `${control.name}?`}"
                                    onchange="updateControlCommand('${control.id}', this.value)"
                                    class="w-full bg-black/30 border border-white/20 rounded px-2 py-1 text-sm focus:border-blue-400 focus:outline-none transition-colors"
                                    placeholder="e.g., get_temp"
                                >
                            </div>
                        </div>
                    </div>
                `;
            }

            // Insert before the existing static controls
            const staticControls = controlsContainer.querySelectorAll('.bg-black\\/20');
            if (staticControls.length > 0) {
                staticControls[0].insertAdjacentHTML('beforebegin', controlElement);
            } else {
                controlsContainer.insertAdjacentHTML('afterbegin', controlElement);
            }
        }

        function updateHubControlUI(control) {
            const controlElement = document.getElementById(`control-${control.id}`);
            if (!controlElement) return;

            // Update value display if it exists
            const valueDisplay = controlElement.querySelector(`#value-${control.id}`);
            if (valueDisplay && control.current_value !== undefined) {
                valueDisplay.textContent = control.current_value;
            }

            // Update slider value if it exists
            const slider = controlElement.querySelector('input[type="range"]');
            if (slider && control.current_value !== undefined) {
                slider.value = control.current_value;
            }
        }

        function clearAllHubControls() {
            // Clear all hub controls from the UI
            const controlsContainer = document.querySelector('.space-y-4');
            if (controlsContainer) {
                // Remove all dynamically added controls (keep the static "Add Control" button)
                const dynamicControls = controlsContainer.querySelectorAll('[id^="control-"]');
                dynamicControls.forEach(control => control.remove());
            }

            // Clear local hub controls array
            hubControls.length = 0;

            console.log('All hub controls cleared from UI');
        }

        function removeHubControlUI(controlId) {
            const controlElement = document.getElementById(`control-${controlId}`);
            if (controlElement) {
                controlElement.remove();
            }
        }

        function sendControlCommand(controlId, value) {
            if (!socket || !socket.connected) {
                alert('Not connected to server');
                return;
            }

            socket.emit('send_control_command', {id: controlId, value: value});
        }

        function sendToggleCommand(controlId, isChecked) {
            if (!socket || !socket.connected) {
                alert('Not connected to server');
                return;
            }

            const control = hubControls.find(c => c.id === controlId);
            if (!control) return;

            const valueOptions = control.config.value_options || ['0', '1'];
            const value = isChecked ? valueOptions[1] : valueOptions[0];

            socket.emit('send_control_command', {id: controlId, value: value});
        }

        function updateControlValueDisplay(controlId, value) {
            const valueDisplay = document.getElementById(`value-${controlId}`);
            if (valueDisplay) {
                valueDisplay.textContent = value;
            }
        }

        function updateControlScale(controlId, type, value) {
            if (!socket || !socket.connected) return;

            const control = hubControls.find(c => c.id === controlId);
            if (!control) return;

            const updateData = {id: controlId, config: {}};
            updateData.config[type] = parseFloat(value) || 0;

            socket.emit('update_hub_control', updateData);
        }

        function updateControlCommand(controlId, commandName) {
            if (!socket || !socket.connected) return;

            const control = hubControls.find(c => c.id === controlId);
            if (!control) return;

            const updateData = {id: controlId, config: {}};
            updateData.config['command_template'] = `${commandName}={value}`;

            socket.emit('update_hub_control', updateData);
        }

        function handleCustomValueKeypress(event, controlId, index) {
            if (event.key === 'Enter') {
                const inputElement = document.getElementById(`val${index + 1}-custom-${controlId}`);
                if (!inputElement) return;

                const customValue = inputElement.value.trim();
                if (!customValue) return;

                updateToggleValue(controlId, index, customValue);
                inputElement.value = ''; // Clear the input after use
            }
        }

        function confirmToggleValue(controlId, index) {
            const selectElement = document.getElementById(`val${index + 1}-select-${controlId}`);
            const customInput = document.getElementById(`val${index + 1}-custom-${controlId}`);

            let selectedValue = '';

            // Check if there's a value in the custom input first
            if (customInput && customInput.value.trim()) {
                selectedValue = customInput.value.trim();

                // Add the custom value to the dropdown if it's not already there
                if (selectElement) {
                    let optionExists = false;
                    for (let i = 0; i < selectElement.options.length; i++) {
                        if (selectElement.options[i].value === selectedValue) {
                            optionExists = true;
                            break;
                        }
                    }

                    if (!optionExists) {
                        const newOption = document.createElement('option');
                        newOption.value = selectedValue;
                        newOption.textContent = selectedValue;
                        selectElement.appendChild(newOption);
                    }

                    // Select the value in the dropdown
                    selectElement.value = selectedValue;
                }

                customInput.value = ''; // Clear after use
            } else if (selectElement && selectElement.value) {
                selectedValue = selectElement.value;
            }

            if (!selectedValue) return;

            updateToggleValue(controlId, index, selectedValue);
        }



        function updateToggleValue(controlId, index, value) {
            if (!socket || !socket.connected) return;

            const control = hubControls.find(c => c.id === controlId);
            if (!control) return;

            // Update local control object immediately
            if (!control.config.value_options) {
                control.config.value_options = ['0', '1'];
            }
            control.config.value_options[index] = value;

            const updateData = {id: controlId, config: {}};
            updateData.config['value_options'] = control.config.value_options;

            socket.emit('update_hub_control', updateData);
        }

        function updateSliderValue(controlId, value) {
            // Update the displayed value in real-time
            const valueDisplay = document.getElementById(`value-${controlId}`);
            if (valueDisplay) {
                const control = hubControls.find(c => c.id === controlId);
                const unit = control && control.config.unit ? ' ' + control.config.unit : '';
                valueDisplay.textContent = value + unit;
            }
        }

        function updateSliderRange(controlId, type, value) {
            if (!socket || !socket.connected) return;

            const control = hubControls.find(c => c.id === controlId);
            if (!control) return;

            // Update the slider's min/max attributes
            const slider = document.querySelector(`#control-${controlId} input[type="range"]`);
            if (slider) {
                slider.setAttribute(type, value);
                // Update the control config
                control.config[type] = parseFloat(value) || 0;
            }

            // Send update to server
            const updateData = {id: controlId, config: {}};
            updateData.config[type] = parseFloat(value) || 0;

            socket.emit('update_hub_control', updateData);
        }

        function deleteHubControl(controlId) {
            if (!socket || !socket.connected) {
                alert('Not connected to server');
                return;
            }

            // Check if control exists in our local array
            const controlExists = hubControls.some(c => c.id === controlId);
            if (!controlExists) {
                console.warn(`Control ${controlId} not found locally, but attempting deletion anyway`);
            }

            if (confirm('Are you sure you want to delete this control?')) {
                socket.emit('delete_hub_control', {id: controlId});
            }
        }

        function setupHubControls() {
            // Add Control button
            const addControlBtn = document.querySelector('.bg-purple-500\\/20');
            if (addControlBtn) {
                addControlBtn.addEventListener('click', function() {
                    showAddControlModal();
                });
            }

            // Load existing controls on page load
            fetch('/hub/controls')
                .then(response => response.json())
                .then(data => {
                    if (data.controls && data.controls.length > 0) {
                        data.controls.forEach(control => {
                            hubControls.push(control);
                            renderHubControl(control);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading hub controls:', error);
                });
        }

        function showAddControlModal() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 border border-white/10">
                    <h3 class="text-xl font-semibold mb-4 text-white">Add New Control</h3>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-300">
                                Control Name
                            </label>
                            <input
                                type="text"
                                id="controlNameInput"
                                placeholder="Enter control name..."
                                class="w-full bg-black/30 border border-white/20 rounded px-3 py-2 focus:border-blue-400 focus:outline-none transition-colors"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-300">
                                Control Type
                            </label>
                            <div class="grid grid-cols-3 gap-2">
                                <button
                                    onclick="selectControlType('slider')"
                                    class="control-type-btn bg-black/30 border border-white/20 rounded px-3 py-2 text-sm hover:border-blue-400 transition-colors"
                                    data-type="slider"
                                >
                                    Slider
                                </button>
                                <button
                                    onclick="selectControlType('toggle')"
                                    class="control-type-btn bg-black/30 border border-white/20 rounded px-3 py-2 text-sm hover:border-blue-400 transition-colors"
                                    data-type="toggle"
                                >
                                    Toggle
                                </button>
                                <button
                                    onclick="selectControlType('reader')"
                                    class="control-type-btn bg-black/30 border border-white/20 rounded px-3 py-2 text-sm hover:border-blue-400 transition-colors"
                                    data-type="reader"
                                >
                                    Reader
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button
                            onclick="closeAddControlModal()"
                            class="px-4 py-2 bg-gray-600/20 hover:bg-gray-600/30 border border-gray-600/50 rounded-lg transition-all duration-200"
                        >
                            Cancel
                        </button>
                        <button
                            id="createControlBtn"
                            onclick="createControlFromModal()"
                            class="px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/50 rounded-lg transition-all duration-200"
                            disabled
                        >
                            Create Control
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Focus on name input
            setTimeout(() => {
                const nameInput = document.getElementById('controlNameInput');
                if (nameInput) nameInput.focus();
            }, 100);
        }

        function selectControlType(type) {
            // Remove previous selection
            document.querySelectorAll('.control-type-btn').forEach(btn => {
                btn.classList.remove('border-blue-400', 'bg-blue-500/20');
                btn.classList.add('border-white/20', 'bg-black/30');
            });

            // Add selection to clicked button
            const selectedBtn = document.querySelector(`[data-type="${type}"]`);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-white/20', 'bg-black/30');
                selectedBtn.classList.add('border-blue-400', 'bg-blue-500/20');
            }

            // Store selected type
            window.selectedControlType = type;

            // Enable create button if name is entered
            updateCreateButtonState();
        }

        function updateCreateButtonState() {
            const nameInput = document.getElementById('controlNameInput');
            const createBtn = document.getElementById('createControlBtn');
            const name = nameInput ? nameInput.value.trim() : '';
            const typeSelected = window.selectedControlType;

            if (createBtn) {
                createBtn.disabled = !name || !typeSelected;
            }
        }

        function createControlFromModal() {
            const nameInput = document.getElementById('controlNameInput');
            const controlName = nameInput ? nameInput.value.trim() : '';
            const controlType = window.selectedControlType;

            if (!controlName || !controlType) {
                return;
            }

            // Close modal
            closeAddControlModal();

            // Create control with type
            createHubControlUI(controlName, controlType);
        }

        function closeAddControlModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
            if (modal) {
                modal.remove();
            }
            window.selectedControlType = null;
        }

        // Listen for Enter key in modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
                if (modal) {
                    const createBtn = document.getElementById('createControlBtn');
                    if (createBtn && !createBtn.disabled) {
                        createControlFromModal();
                    }
                }
            } else if (e.key === 'Escape') {
                closeAddControlModal();
            }
        });

        // Update create button state when typing
        document.addEventListener('input', function(e) {
            if (e.target.id === 'controlNameInput') {
                updateCreateButtonState();
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
            setupFlashButton();
            setupFileUpload();
            setupSerialControls(); // Initialize serial controls
            setupStreamingControls(); // Initialize video/audio controls
            setupHubControls(); // Initialize hub controls
            refreshDevices(); // Load devices on page load
            updateSlideCarousel(); // Initialize slide carousel
        });
    </script>
</body>
</html>
